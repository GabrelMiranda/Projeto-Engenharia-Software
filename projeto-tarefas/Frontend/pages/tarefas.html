<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Minhas Tarefas</title>
    <link rel="stylesheet" href="../css/tarefas.css">
</head>

<body>

    <!-- Cabeçalho -->
    <header class="header">
        <h1>Minhas Tarefas</h1>
        <button class="logout-btn" onclick="window.location.href='../../backend/logout.php'">Sair</button>
    </header>

    <!-- Conteúdo principal -->
    <main class="main-content">

        <!-- Filtro de categoria -->
        <div class="filter">
            <label for="filtro">Filtrar por status:</label>
            <select id="filtro" onchange="carregarTarefas()">
                <option value="todas">Todas</option>
                <option value="Trabalho">Pendente</option>
                <option value="Estudos">Em andamento</option>
                <option value="Pessoal">Concluída</option>
            </select>
        </div>

        <!-- Mensagem de feedback -->
        <div id="mensagem" style="text-align:center; margin-bottom:10px;"></div>

        <!-- Lista de tarefas -->
        <ul id="lista-tarefas" class="task-list"></ul>
    </main>

    <!-- Botão flutuante -->
    <button class="add-btn" onclick="window.location.href='editar.html'">+</button>

    <script>
        // Carrega as tarefas do usuário
        async function carregarTarefas() {
            const filtro = document.getElementById("filtro").value;
            const response = await fetch("../../backend/tarefas.php");
            const tarefas = await response.json();

            const lista = document.getElementById("lista-tarefas");
            lista.innerHTML = "";

            tarefas
                .filter(t => filtro === "todas" || t.categoria === filtro)
                .forEach(t => {
                    const li = document.createElement("li");
                    li.className = "task-item" + (t.concluida == 1 ? " concluida" : "");

                    li.innerHTML = `
            <div class="task-info">
              <h3>${t.titulo}</h3>
              <p>${t.categoria}</p>
            </div>
            <div class="task-actions">
              <button class="btn-small" onclick="editar(${t.id})">✏️</button>
              <button class="btn-small" onclick="window.location.href='../../backend/concluir.php?id=${t.id}'">✅</button>
              <button class="btn-small" onclick="window.location.href='../../backend/excluir.php?id=${t.id}'">❌</button>
            </div>
          `;

                    lista.appendChild(li);
                });
        }

        function editar(id) {
            window.location.href = `editar.html?id=${id}`;
        }

        carregarTarefas();

        // Exibe mensagem de sucesso/erro
        const urlParams = new URLSearchParams(window.location.search);
        const msg = urlParams.get("msg");
        const mensagem = document.getElementById("mensagem");

        if (msg) {
            let texto = "";
            let cor = "green";

            switch (msg) {
                case "sucesso_adicionar":
                    texto = "Tarefa adicionada com sucesso!";
                    break;
                case "sucesso_editar":
                    texto = "Tarefa atualizada com sucesso!";
                    break;
                case "sucesso_excluir":
                    texto = "Tarefa excluída!";
                    cor = "red";
                    break;
                case "sucesso_concluir":
                    texto = "Tarefa marcada como concluída!";
                    break;
            }

            if (texto) {
                mensagem.innerHTML = `<p style="color:${cor}; font-weight:500;">${texto}</p>`;
                setTimeout(() => {
                    mensagem.innerHTML = "";
                    history.replaceState(null, "", window.location.pathname);
                }, 2500);
            }
        }
    </script>

</body>

</html>